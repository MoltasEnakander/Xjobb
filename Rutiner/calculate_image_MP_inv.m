function rcs =  calculate_image_MP_inv(pts,X,f,phi,r,ff)
nx = max(size(X));
fstart = f(1);
fstop = f(end);
nf = length(f);
nphi_in = length(phi);
nprocessors = getenv('NUMBER_OF_PROCESSORS');
nim = str2num(nprocessors);
if (nphi_in<nim*2)
    nim = 1;
    nphi = nphi_in;
end
if nim>12
    nim = 12;
end
% disp(['Running ' num2str(nim) ' parallel processes'])
if nim==1
    phistart = phi(1);
    phistop = phi(end);
    parr(1) = r;
    parr(2) = phistart;
    parr(3) = phistop;
    parr(4) = fstart;
    parr(5) = fstop;
    pari(1) = nphi_in;
    pari(2) = nf;
    pari(3) = nx;
    pari(4) = ff;
    rcs = isar_image_inv(pts,parr,pari,X);   
elseif (nim==4)
    parr(1) = r;
    parr(2) = fstart;
    parr(3) = fstop;
    pari(1) = nf;
    pari(2) = nx;
    pari(3) = ff;
    na = length(phi);
    nl = floor(na/4);
    nstart = [1 1+nl 1+2*nl 1+3*nl];
    nstop = [nl 2*nl 3*nl na];
    nphi(1) = nstop(1)-nstart(1)+1;
    phistart(1) = phi(nstart(1));
    phistop(1) = phi(nstop(1));
    nphi(2) = nstop(2)-nstart(2)+1;
    phistart(2) = phi(nstart(2));
    phistop(2) = phi(nstop(2));
    nphi(3) = nstop(3)-nstart(3)+1;
    phistart(3) = phi(nstart(3));
    phistop(3) = phi(nstop(3));
    nphi(4) = nstop(4)-nstart(4)+1;
    phistart(4) = phi(nstart(4));
    phistop(4) = phi(nstop(4));
    [rcs1,rcs2,rcs3,rcs4] = isar_image_inv4(pts,parr,pari,phistart,phistop,nphi,X);
    rcs = [rcs1 rcs2 rcs3 rcs4];
elseif (nim==8)
    parr(1) = r;
    parr(2) = fstart;
    parr(3) = fstop;
    pari(1) = nf;
    pari(2) = nx;
    pari(3) = ff;
    na = length(phi);
    nl = floor(na/8);
    nstart = [1 1+nl 1+2*nl 1+3*nl 1+4*nl 1+5*nl 1+6*nl 1+7*nl];
    nstop = [nl 2*nl 3*nl 4*nl 5*nl 6*nl 7*nl na];
    nphi(1) = nstop(1)-nstart(1)+1;
    phistart(1) = phi(nstart(1));
    phistop(1) = phi(nstop(1));
    nphi(2) = nstop(2)-nstart(2)+1;
    phistart(2) = phi(nstart(2));
    phistop(2) = phi(nstop(2));
    nphi(3) = nstop(3)-nstart(3)+1;
    phistart(3) = phi(nstart(3));
    phistop(3) = phi(nstop(3));
    nphi(4) = nstop(4)-nstart(4)+1;
    phistart(4) = phi(nstart(4));
    phistop(4) = phi(nstop(4));
    nphi(5) = nstop(5)-nstart(5)+1;
    phistart(5) = phi(nstart(5));
    phistop(5) = phi(nstop(5));
    nphi(6) = nstop(6)-nstart(6)+1;
    phistart(6) = phi(nstart(6));
    phistop(6) = phi(nstop(6));
    nphi(7) = nstop(7)-nstart(7)+1;
    phistart(7) = phi(nstart(7));
    phistop(7) = phi(nstop(7));
    nphi(8) = nstop(8)-nstart(8)+1;
    phistart(8) = phi(nstart(8));
    phistop(8) = phi(nstop(8));
    [rcs1,rcs2,rcs3,rcs4,rcs5,rcs6,rcs7,rcs8] = isar_image_inv8(pts,parr,pari,phistart,phistop,nphi,X);
    rcs = [rcs1 rcs2 rcs3 rcs4 rcs5 rcs6 rcs7 rcs8];
elseif (nim==12)
    parr(1) = r;
    parr(2) = fstart;
    parr(3) = fstop;
    pari(1) = nf;
    pari(2) = nx;
    pari(3) = ff;
    na = length(phi);
    nl = floor(na/12);
    nstart = [1 1+nl 1+2*nl 1+3*nl 1+4*nl 1+5*nl 1+6*nl 1+7*nl 1+8*nl 1+9*nl 1+10*nl 1+11*nl];
    nstop = [nl 2*nl 3*nl 4*nl 5*nl 6*nl 7*nl 8*nl 9*nl 10*nl 11*nl na];
    nphi(1) = nstop(1)-nstart(1)+1;
    phistart(1) = phi(nstart(1));
    phistop(1) = phi(nstop(1));
    nphi(2) = nstop(2)-nstart(2)+1;
    phistart(2) = phi(nstart(2));
    phistop(2) = phi(nstop(2));
    nphi(3) = nstop(3)-nstart(3)+1;
    phistart(3) = phi(nstart(3));
    phistop(3) = phi(nstop(3));
    nphi(4) = nstop(4)-nstart(4)+1;
    phistart(4) = phi(nstart(4));
    phistop(4) = phi(nstop(4));
    nphi(5) = nstop(5)-nstart(5)+1;
    phistart(5) = phi(nstart(5));
    phistop(5) = phi(nstop(5));
    nphi(6) = nstop(6)-nstart(6)+1;
    phistart(6) = phi(nstart(6));
    phistop(6) = phi(nstop(6));
    nphi(7) = nstop(7)-nstart(7)+1;
    phistart(7) = phi(nstart(7));
    phistop(7) = phi(nstop(7));
    nphi(8) = nstop(8)-nstart(8)+1;
    phistart(8) = phi(nstart(8));
    phistop(8) = phi(nstop(8));
    nphi(9) = nstop(9)-nstart(9)+1;
    phistart(9) = phi(nstart(9));
    phistop(9) = phi(nstop(9));
    nphi(10) = nstop(10)-nstart(10)+1;
    phistart(10) = phi(nstart(10));
    phistop(10) = phi(nstop(10));
    nphi(11) = nstop(11)-nstart(11)+1;
    phistart(11) = phi(nstart(11));
    phistop(11) = phi(nstop(11));
    nphi(12) = nstop(12)-nstart(12)+1;
    phistart(12) = phi(nstart(12));
    phistop(12) = phi(nstop(12));
    [rcs1,rcs2,rcs3,rcs4,rcs5,rcs6,rcs7,rcs8,rcs9,rcs10,rcs11,rcs12] = isar_image_inv12(pts,parr,pari,phistart,phistop,nphi,X);
    rcs = [rcs1 rcs2 rcs3 rcs4 rcs5 rcs6 rcs7 rcs8 rcs9 rcs10 rcs11 rcs12];
end
end